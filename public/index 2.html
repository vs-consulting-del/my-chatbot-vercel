<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>VS Legal Asistent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', ui-sans-serif, system-ui; background-color: #f8f5f0; }
    .typing::after { content: ''; display: inline-block; width: 1ch; animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { background: transparent; } 50% { background: black; } }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .dot-menu:hover .dropdown { display: block; }
  </style>
</head>
<body>

<!-- Floating Chat Button -->
<button id="toggleChat" class="fixed bottom-5 right-5 p-3 bg-neutral-900 text-white rounded-full shadow-lg hover:scale-105 transition-all duration-200">
  💬
</button>

<!-- Chat Container -->
<div id="chatWidget" class="hidden fixed bottom-24 right-5 w-[380px] max-w-full bg-white border border-neutral-200 rounded-xl shadow-2xl flex flex-col overflow-hidden fade-in">
  <div class="flex justify-between items-center bg-neutral-800 text-white px-4 py-3">
    <span class="font-semibold text-base">VS Legal Asistent</span>
    <div class="relative dot-menu">
      <button class="text-white text-xl">⋯</button>
      <div class="dropdown hidden absolute right-0 top-7 bg-white border rounded-md shadow-md w-40 z-10 text-sm text-neutral-700">
        <button id="saveChat" class="block w-full text-left px-4 py-2 hover:bg-neutral-100">💾 Sačuvaj razgovor</button>
        <button id="newChat" class="block w-full text-left px-4 py-2 hover:bg-neutral-100">🗑 Novi razgovor</button>
      </div>
    </div>
  </div>
  <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm"></div>
  <div id="typing" class="text-gray-500 italic px-4 pb-2 hidden">Asistent piše<span class="typing"></span></div>
  <div class="flex items-center border-t px-3 py-2">
    <input id="userInput" type="text" placeholder="Unesite pravno pitanje..." class="flex-1 text-sm px-3 py-2 focus:outline-none bg-transparent" />
    <button id="sendBtn" class="ml-2 hover:scale-110 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-800" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
      </svg>
    </button>
  </div>
</div>

<script>
const toggleBtn = document.getElementById("toggleChat");
const chatWidget = document.getElementById("chatWidget");
const messages = document.getElementById("messages");
const input = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const typing = document.getElementById("typing");
const saveChatBtn = document.getElementById("saveChat");
const newChatBtn = document.getElementById("newChat");

toggleBtn.onclick = () => {
  chatWidget.classList.toggle("hidden");
};

function addMessage(text, cls) {
  const div = document.createElement("div");
  div.className = "fade-in p-2 text-sm rounded-xl";
  div.style.background = cls === "bot" ? "#f4f4f4" : "transparent";
  div.style.textAlign = cls === "bot" ? "left" : "right";
  div.style.borderRadius = cls === "bot" ? "10px" : "0px";
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTypingEffect(fullText) {
  let i = 0;
  const div = document.createElement("div");
  div.className = "fade-in p-2 text-sm rounded-xl bg-gray-100 italic";
  messages.appendChild(div);
  const interval = setInterval(() => {
    div.textContent = fullText.slice(0, i++);
    messages.scrollTop = messages.scrollHeight;
    if (i > fullText.length) clearInterval(interval);
  }, 15);
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage("Vi: " + text, "user");
  input.value = "";
  typing.classList.remove("hidden");

  const res = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: text }),
  });

  const data = await res.json();
  typing.classList.add("hidden");
  showTypingEffect("Asistent: " + data.reply);
}

sendBtn.onclick = sendMessage;
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendMessage();
});
newChatBtn.onclick = () => messages.innerHTML = "";
saveChatBtn.onclick = () => {
  const text = Array.from(messages.children).map(div => div.textContent).join("\n");
  const blob = new Blob([text], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "vslegal-razgovor.txt";
  link.click();
};
</script>
</body>
</html>